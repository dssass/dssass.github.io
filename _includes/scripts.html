
<script>
document.addEventListener('DOMContentLoaded', () => {
  // --- 選取所有需要的元素 ---
  const body = document.body;
  const menuToggle = document.getElementById('mobile-menu-toggle');
  const sidebar = document.getElementById('toc-sidebar');
  const overlay = document.getElementById('toc-overlay');
  
  // --- 處理滾動時，目錄項目高亮顯示的邏輯 ---
  const sections = document.querySelectorAll('h2[id], h3[id], h4[id], h5[id]');
  const tocLinks = document.querySelectorAll('#toc-sidebar a');
  const observer = new IntersectionObserver((entries) => {
    // 從所有可見的區塊中，找到最靠近頂部的那一個
    let latestIntersectingEntry = null;
    entries.forEach(entry => {
        if (entry.isIntersecting) {
          if(!latestIntersectingEntry || entry.boundingClientRect.top < latestIntersectingEntry.boundingClientRect.top){
             latestIntersectingEntry = entry;
          }
        }
    });

    if (latestIntersectingEntry) {
        const activeId = latestIntersectingEntry.target.getAttribute('id');
        tocLinks.forEach(link => {
            link.classList.remove('active');
            const linkHref = link.getAttribute('href').substring(1);
            if (linkHref === activeId) {
                link.classList.add('active');
                // 自動展開父層選單
                const parentSubmenu = link.closest('.submenu');
                if (parentSubmenu && !parentSubmenu.parentElement.classList.contains('open')) {
                    parentSubmenu.parentElement.classList.add('open');
                }
            }
        });
    }
  }, { 
    rootMargin: '0px 0px -80% 0px' // 調整這個值可以改變高亮的觸發時機
  });
  sections.forEach(section => {
    observer.observe(section);
  });

  // --- 手機版選單開關功能 ---
  const openMenu = () => body.classList.add('mobile-menu-open');
  const closeMenu = () => body.classList.remove('mobile-menu-open');

  // 點擊漢堡按鈕來開關選單
  menuToggle.addEventListener('click', (event) => {
    event.stopPropagation(); // 避免點擊事件冒泡
    if (body.classList.contains('mobile-menu-open')) {
      closeMenu();
    } else {
      openMenu();
    }
  });
  
  // 點擊半透明遮罩層來關閉選單
  overlay.addEventListener('click', closeMenu);

  // --- 側邊欄點擊的核心邏輯 ---
  sidebar.addEventListener('click', function(event) {
    const targetLink = event.target.closest('a');

    // 如果點的不是連結，就什麼都不做
    if (!targetLink) return;

    // 處理最頂端的 "目錄" 標題連結，點擊它就回到頁面頂端
    if (targetLink.getAttribute('href') === '#') {
        event.preventDefault(); // 阻止跳轉到 #
        window.scrollTo({ top: 0, behavior: 'smooth' }); // 平滑滾動到最頂端
        closeMenu(); // 在手機上關閉選單
        return; // 結束執行
    }
    
    // 如果點擊的是有子選單的父連結 (e.g., '牛肉', '午餐')
    if (targetLink.classList.contains('has-submenu')) {
      // 阻止頁面跳轉到 #lunch, #dinner 等
      event.preventDefault(); 
      // 僅切換子選單的展開/收合狀態
      targetLink.parentElement.classList.toggle('open');
    } 
    // 如果點擊的是最終的目標連結 (e.g., '台式飯類', '牛肉火鍋')
    else {
      // 同樣先阻止預設的瞬間跳轉行為，這樣網址就不會改變！
      event.preventDefault();
      const targetId = targetLink.getAttribute('href');
      const targetElement = document.querySelector(targetId);

      // 手動執行平滑滾動
      if (targetElement) {
        targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
      
      // 在手機模式下，點擊後自動關閉選單
      closeMenu();
    }
  });
});
</script>
