<script>
    document.addEventListener('DOMContentLoaded', () => {
      // æ·»åŠ è¼‰å…¥å‹•ç•«
      setTimeout(() => {
        document.querySelector('.container').classList.remove('loading');
      }, 100);

      // --- é¸å–æ‰€æœ‰éœ€è¦çš„å…ƒç´  ---
      const body = document.body;
      const menuToggle = document.getElementById('mobile-menu-toggle');
      const sidebar = document.getElementById('toc-sidebar');
      const overlay = document.getElementById('toc-overlay');
      const searchInput = document.querySelector('.search-input');
      const searchResults = document.querySelector('.search-results');
      
      // å‰µå»ºé¤å»³æœå°‹ç´¢å¼•
      const restaurants = [];
      document.querySelectorAll('ul > li > a[href^="https://maps"]').forEach(link => {
        const name = link.textContent.trim();
        const section = link.closest('section')?.querySelector('h2')?.textContent || '';
        const subsection = link.closest('ul').previousElementSibling?.textContent || '';
        restaurants.push({
          name,
          section,
          subsection,
          element: link.closest('li')
        });
      });

      // æœå°‹åŠŸèƒ½
      let searchTimeout;
      searchInput?.addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        const query = e.target.value.trim().toLowerCase();
        
        searchTimeout = setTimeout(() => {
          if (query.length === 0) {
            searchResults.style.display = 'none';
            searchResults.innerHTML = '';
            return;
          }

          const filteredResults = restaurants.filter(restaurant => 
            restaurant.name.toLowerCase().includes(query) ||
            restaurant.section.toLowerCase().includes(query) ||
            restaurant.subsection.toLowerCase().includes(query)
          ).slice(0, 8);

          if (filteredResults.length > 0) {
            searchResults.innerHTML = filteredResults.map(result => 
              `<div class="search-result-item" data-name="${result.name}">
                <strong>${result.name}</strong>
                <br><small style="color: #666;">${result.section} ${result.subsection ? '> ' + result.subsection : ''}</small>
              </div>`
            ).join('');
            searchResults.style.display = 'block';
          } else {
            searchResults.innerHTML = '<div class="search-result-item">æ‰¾ä¸åˆ°ç›¸é—œé¤å»³</div>';
            searchResults.style.display = 'block';
          }
        }, 300);
      });

      // æœå°‹çµæœé»æ“Š
      searchResults?.addEventListener('click', (e) => {
        const item = e.target.closest('.search-result-item');
        if (item && item.dataset.name) {
          const restaurant = restaurants.find(r => r.name === item.dataset.name);
          if (restaurant) {
            restaurant.element.scrollIntoView({ behavior: 'smooth', block: 'center' });
            restaurant.element.style.transform = 'scale(1.02)';
            restaurant.element.style.boxShadow = '0 8px 25px rgba(232,116,0,0.3)';
            setTimeout(() => {
              restaurant.element.style.transform = '';
              restaurant.element.style.boxShadow = '';
            }, 2000);
          }
          searchInput.value = '';
          searchResults.style.display = 'none';
        }
      });

      // é»æ“Šå…¶ä»–åœ°æ–¹é—œé–‰æœå°‹çµæœ
      document.addEventListener('click', (e) => {
        if (!e.target.closest('.search-container')) {
          searchResults.style.display = 'none';
        }
      });
      
      // --- è™•ç†æ»¾å‹•æ™‚ï¼Œç›®éŒ„é …ç›®é«˜äº®é¡¯ç¤ºçš„é‚è¼¯ ---
      const sections = document.querySelectorAll('h2[id], h3[id], h4[id], h5[id]');
      const tocLinks = document.querySelectorAll('#toc-sidebar a');
      
      const observer = new IntersectionObserver((entries) => {
        let latestIntersectingEntry = null;
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            if (!latestIntersectingEntry || entry.boundingClientRect.top < latestIntersectingEntry.boundingClientRect.top) {
              latestIntersectingEntry = entry;
            }
          }
        });

        if (latestIntersectingEntry) {
          const activeId = latestIntersectingEntry.target.getAttribute('id');
          tocLinks.forEach(link => {
            link.classList.remove('active');
            const linkHref = link.getAttribute('href').substring(1);
            if (linkHref === activeId) {
              link.classList.add('active');
              // è‡ªå‹•å±•é–‹çˆ¶å±¤é¸å–®
              const parentSubmenu = link.closest('.submenu');
              if (parentSubmenu && !parentSubmenu.parentElement.classList.contains('open')) {
                parentSubmenu.parentElement.classList.add('open');
              }
            }
          });
        }
      }, { 
        rootMargin: '0px 0px -80% 0px'
      });
      
      sections.forEach(section => {
        observer.observe(section);
      });

      // --- æ‰‹æ©Ÿç‰ˆé¸å–®é–‹é—œåŠŸèƒ½ ---
      const openMenu = () => body.classList.add('mobile-menu-open');
      const closeMenu = () => body.classList.remove('mobile-menu-open');

      // é»æ“Šæ¼¢å ¡æŒ‰éˆ•ä¾†é–‹é—œé¸å–®
      menuToggle?.addEventListener('click', (event) => {
        event.stopPropagation();
        if (body.classList.contains('mobile-menu-open')) {
          closeMenu();
        } else {
          openMenu();
        }
      });
      
      // é»æ“ŠåŠé€æ˜é®ç½©å±¤ä¾†é—œé–‰é¸å–®
      overlay?.addEventListener('click', closeMenu);

      // --- å´é‚Šæ¬„é»æ“Šçš„æ ¸å¿ƒé‚è¼¯ ---
      sidebar?.addEventListener('click', function(event) {
        const targetLink = event.target.closest('a');

        if (!targetLink) return;

        // è™•ç†æœ€é ‚ç«¯çš„ "ç›®éŒ„" æ¨™é¡Œé€£çµ
        if (targetLink.getAttribute('href') === '#') {
          event.preventDefault();
          window.scrollTo({ top: 0, behavior: 'smooth' });
          closeMenu();
          return;
        }
        
        // å¦‚æœé»æ“Šçš„æ˜¯æœ‰å­é¸å–®çš„çˆ¶é€£çµ
        if (targetLink.classList.contains('has-submenu')) {
          event.preventDefault(); 
          targetLink.parentElement.classList.toggle('open');
        } 
        // å¦‚æœé»æ“Šçš„æ˜¯æœ€çµ‚çš„ç›®æ¨™é€£çµ
        else {
          event.preventDefault();
          const targetId = targetLink.getAttribute('href');
          const targetElement = document.querySelector(targetId);

          if (targetElement) {
            targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }
          
          closeMenu();
        }
      });

      // ç‚ºå¤–éƒ¨é€£çµæ·»åŠ  loading æ•ˆæœ
      document.querySelectorAll('a[href^="https://maps"]').forEach(link => {
        link.addEventListener('click', (e) => {
          const spinner = document.createElement('span');
          spinner.innerHTML = ' ğŸ”„';
          spinner.style.animation = 'spin 1s linear infinite';
          link.appendChild(spinner);
          
          setTimeout(() => {
            spinner.remove();
          }, 2000);
        });
      });

      // æ·»åŠ æ—‹è½‰å‹•ç•«
      const style = document.createElement('style');
      style.textContent = `
        @keyframes spin {
          from { transform: rotate(0deg); }
          to { transform: rotate(360deg); }
        }
      `;
      document.head.appendChild(style);
    });
  </script>
